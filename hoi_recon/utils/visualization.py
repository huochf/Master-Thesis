import numpy as np
import cv2


def visualize_sparse_keypoints_3d(smpl_kps_3d, object_kps_3d, object_name, res=256):
    # smpl_kps: [-1, 1]
    smpl_kps_3d[:, 2] += 2
    smpl_kps_3d[:, :2] = (smpl_kps_3d[:, :2] / smpl_kps_3d[:, 2:] + 0.5) * res

    object_kps_3d[:, 2] += 2
    object_kps_3d[:, :2] = (object_kps_3d[:, :2] / object_kps_3d[:, 2:] + 0.5) * res
    
    image = np.ones((res, res, 3), dtype=np.uint8) * 255
    image = draw_smpl_joints(image, smpl_kps_3d[:, :2])
    image = draw_object_keypoints(image, object_kps_3d[:, :2], object_name)
    image = image[::-1]

    return image



def draw_smpl_joints(image, joints_2d):
    joints_2d = joints_2d[:22]

    bone_idx = [[ 0,  1], [ 0,  2], [ 0,  3], 
                [ 1,  4], [ 2,  5], [ 3,  6], 
                [ 4,  7], [ 5,  8], [ 6,  9], 
                [ 7, 10], [ 8, 11], [ 9, 12], 
                [ 9, 13], [ 9, 14], [12, 15],
                [13, 16], [14, 17], [16, 18],
                [17, 19], [18, 20], [19, 21]]
    points_colors = [
        [0.,    255.,  255.],
        [0.,   255.,    170.],
        [0., 170., 255.,],
        [85., 170., 255.],
        [0.,   255.,   85.], # 4
        [0., 85., 255.],
        [170., 85., 255.],
        [0.,   255.,   0.], # 7
        [0., 0., 255.], 
        [255., 0., 255.],
        [0.,    255.,  0.], # 10
        [0., 0., 255.],
        [255., 85., 170.],
        [170., 0, 255.],
        [255., 0., 170.],
        [255., 170., 85.],
        [85., 0., 255.],
        [255., 0., 85],
        [32., 0., 255.],
        [255., 0, 32],
        [0., 0., 255.],
        [255., 0., 0.],
    ]

    line_thickness = 2
    thickness = 4
    lineType = 8

    for bone in bone_idx:
        idx1, idx2 = bone
        x1, y1 = joints_2d[idx1]
        x2, y2 = joints_2d[idx2]
        cv2.line(image, (int(x1), int(y1)), (int(x2), int(y2)), tuple(points_colors[idx1]), line_thickness, lineType)

    for i, points in enumerate(joints_2d):
        x, y = points
        x, y = int(x), int(y)
        cv2.circle(image, (x, y), thickness, points_colors[i], thickness=-1, lineType=lineType)

    return image


def draw_object_keypoints(image, keypoints_2d, obj_name):
    keypoint_linkages = {
        'backpack': [[0, 1],[1, 2], [2, 3], [3, 0], [0, 5], [1, 6], [2, 7], [3, 4], [4, 5], [5, 6], [6, 7], [7, 4]],
        'basketball': [],
        'boxlarge': [[0, 1],[1, 2], [2, 3], [3, 0], [0, 5], [1, 6], [2, 7], [3, 4], [4, 5], [5, 6], [6, 7], [7, 4]],
        'boxlong': [[0, 1],[1, 2], [2, 3], [3, 0], [0, 5], [1, 6], [2, 7], [3, 4], [4, 5], [5, 6], [6, 7], [7, 4]],
        'boxmedium': [[0, 1],[1, 2], [2, 3], [3, 0], [0, 5], [1, 6], [2, 7], [3, 4], [4, 5], [5, 6], [6, 7], [7, 4]],
        'boxsmall': [[0, 1],[1, 2], [2, 3], [3, 0], [0, 5], [1, 6], [2, 7], [3, 4], [4, 5], [5, 6], [6, 7], [7, 4]],
        'boxtiny': [[0, 1],[1, 2], [2, 3], [3, 0], [0, 5], [1, 6], [2, 7], [3, 4], [4, 5], [5, 6], [6, 7], [7, 4]],
        'chairblack': [[0, 1], [1, 13], [13, 2], [2, 15], [15, 3], [3, 4], [4, 5], [5, 6], [6, 7], [7, 8], [8, 12], [12, 9],
                       [9, 10], [10, 0], [10, 11], [11, 12], [13, 14], [14, 15], [3, 8], [2, 9]],
        'chairwood': [[0, 1], [1, 2], [2, 3], [3, 4], [4, 5], [5, 2], [2, 6], [3, 7], [4, 8], [5, 9], [0, 5]],
        'keyboard': [[0, 1], [1, 2], [2, 3], [3, 0]],
        'monitor': [[0, 1], [1, 2], [2, 3], [0, 3], [0, 4], [1, 4], [2, 4], [3, 4], [4, 5], [5, 6], [5, 7]],
        'plasticcontainer': [[0, 1], [1, 2], [2, 3], [3, 0], [4, 5], [5, 6], [6, 7], 
                             [7, 4], [0, 4], [1, 5], [2, 6], [3, 7], [4, 6], [5, 7]],
        'stool': [[0, 1], [1, 2], [2, 0], [3, 4], [4, 5], [5, 3], [0, 3], [1, 4], [2, 5]],
        'suitcase': [[0, 1],[1, 2], [2, 3], [3, 0], [0, 5], [1, 6], [2, 7], [3, 4], [4, 5], [5, 6], [6, 7], [7, 4]],
        'tablesmall': [[0, 1], [1, 2], [2, 3], [3, 0], [0, 4], [1, 4], [2, 4], [3, 4], [4, 5], [5, 6], [5, 7], [5, 8], [5, 9]],
        'tablesquare': [[0, 1], [1, 2], [2, 3], [3, 0], [0, 4], [1, 5], [2, 6], [3, 7]],
        'toolbox': [[0, 1],[1, 2], [2, 3], [3, 0], [0, 5], [1, 6], [2, 7], [3, 4], [4, 5], [5, 6], [6, 7], [7, 4]],
        'trashbin': [[0, 1]],
        'yogaball': [],
        'yogamat': [[0, 1]],
        'suitcase1': [[0, 1], [1, 2], [0, 3], [2, 4], [2, 3], [3, 7], [4, 5], [6, 7], 
                      [5, 6], [4, 8], [5, 9], [6, 10], [7, 11], [8, 9], [9, 10], [10, 11], [8, 11]],
        'sports': [],
        'umbrella': [[0, 1], [1, 2], [2, 3], [0, 4], [0, 5], [0, 6], [0, 7], [0, 8], [0, 9], [0, 10], [0, 11]],
        'suitcase2': [[0, 1], [1, 2], [0, 3], [2, 3], [4, 7], [2, 4], [2, 5], [3, 6], [3, 7], [4, 5], [6, 7], 
                      [5, 6], [4, 8], [5, 9], [6, 10], [7, 11], [8, 9], [9, 10], [10, 11], [8, 11]],
        'chair1': [[0, 1], [0, 2], [0, 3], [0, 4], [0, 5], [1, 6], [1, 7], [1, 8], [1, 9], [6, 7], [7, 8], [8, 9], [9, 6],
                   [6, 10], [10, 12], [10, 11], [11, 12], [9, 13], [13, 14], [13, 15], [14, 15], [11, 14]],
        'bottle': [[0, 1]],
        'cup': [[0, 1]],
        'chair2': [[0, 1], [0, 2], [0, 3], [0, 4], [0, 5], [1, 6], [1, 7], [1, 8], [1, 9], [6, 7], [7, 8], [8, 9], [9, 6]],
        'skate': [[0, 1], [1, 6], [6, 2], [2, 0], [1, 7], [7, 5], [2, 9], [9, 4], 
                    [3, 4], [4, 8], [8, 5], [5, 3], [1, 10], [10, 4], [2, 10], [10, 5]],
        'tennis': [[0, 1], [1, 2], [2, 3], [3, 4], [3, 5], [2, 5], [5, 6], [6, 0]],
    }
    points_colors = [
        [0.,    255.,  255.],
        [0.,   255.,    170.],
        [0., 170., 255.,],
        [85., 170., 255.],
        [0.,   255.,   85.], # 4
        [0., 85., 255.],
        [170., 85., 255.],
        [0.,   255.,   0.], # 7
        [0., 0., 255.], 
        [255., 0., 255.],
        [0.,    255.,  0.], # 10
        [0., 0., 255.],
        [255., 85., 170.],
        [170., 0, 255.],
        [255., 0., 170.],
        [255., 170., 85.],
        [85., 0., 255.],
        [255., 0., 85],
        [32., 0., 255.],
        [255., 0, 32],
        [0., 0., 255.],
        [255., 0., 0.],
    ]

    line_thickness = 2
    thickness = 4
    lineType = 8

    for bone in keypoint_linkages[obj_name]:
        idx1, idx2 = bone
        x1, y1 = keypoints_2d[idx1]
        x2, y2 = keypoints_2d[idx2]
        cv2.line(image, (int(x1), int(y1)), (int(x2), int(y2)), tuple(points_colors[idx1]), line_thickness, lineType)

    for i, points in enumerate(keypoints_2d):
        x, y = points
        x, y = int(x), int(y)
        cv2.circle(image, (x, y), thickness, points_colors[i], thickness=-1, lineType=lineType)

    return image
